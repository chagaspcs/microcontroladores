;====================================================================
; Main.asm file generated by New Project wizard
;
; Created:   qua mai 8 2019
; Processor: PIC16F877A
; Compiler:  MPASM (Proteus)
;====================================================================
; AUTOR: PATRICK CHAGAS DOS SANTOS
;	 PH	
;	 TAINÁ
;====================================================================
; CÓDIGO PARA CONTROLE DE MÁQUINA DE CAFÉ EXPRESSO, 
; CONFORME ARQUIVO LISTA02.PDF
;====================================================================
; DEFINITIONS
;====================================================================

#include p16f877a.inc                ; Include register definition file


; --- CONFIG ---
; operando a 20MHz

 __CONFIG _FOSC_HS & _WDTE_OFF & _PWRTE_ON & _MCLRE_ON & _BOREN_ON & _LVP_OFF & _CPD_OFF & _CP_OFF

;
 ; PAGINAÇÃO DE MEMÓRIA
 ;
 
 #DEFINE	BANK0  BCF STATUS,RP0				;SETA BANK 0 DE MEMÓRIA
 #DEFINE	BANK1  BSF STATUS,RP0  				;SETA BANK 1 DE MEMÓRIA
 #DEFINE	BANK2  BCF STATUS,RP1				;SETA BANK 2 DE MEMÓRIA
 #DEFINE	BANK3  BSF STATUS,RP1  				;SETA BANK 3 DE MEMÓRIA 
 ;
 ; DEFINIÇÃO DE VARIÁVEIS
 ;
 
 CBLOCK 0X70  							;ENDEREÇO INICIAL DA MEMÓRIA DE USUÁRIO
	d1
	d2
	d3
 ENDC  								;FIM DO BLOCO DE MEMÓRIA
 
 ; --- DEFINIÇÃO DE PINOS DE ENTRADA ---
 
 ;CHAVE PARA CAFÉ PEQUENO 
 ; 0: SIM 
 ; 1: NÃO
 #DEFINE 	EXPRESS	PORTB,0  
 
 ;CHAVE PARA CAFÉ MÉDIO
 ; 0: SIM 
 ; 1: NÃO
 #DEFINE 	MED	PORTB,1
 
 ;CHAVE PARA CAFÉ CHEIO
 ; 0: SIM
 ; 1: NÃO
 #DEFINE 	FULL	PORTB,2      
 
 ;CHAVE PARA CAFÉ EXPRESSO E ESQUENTA ÁGUA
 ; 0: SIM
 ; 1: NÃO
 #DEFINE 	HOT	PORTB,3    

 ;GRAU DE MOAGEM BIT MAIS SIGNIFICATIVO
 ; 0: SIM
 ; 1: NÃO
 #DEFINE 	S8	PORTD,0

 ;GRAU DE MOAGEM
 ; 0: SIM
 ; 1: NÃO
 #DEFINE 	S7	PORTD,1 
 
 ;GRAU DE MOAGEM BIT MENOS SIGNIFICATIVO
 ; 0: SIM
 ; 1: NÃO
 #DEFINE 	S6	PORTD,2 
 
  ;GRAU DE MOAGEM BIT MAIS SIGNIFICATIVO
 ; 0: SIM
 ; 1: NÃO
 #DEFINE 	S5	PORTD,3

 ;GRAU DE MOAGEM
 ; 0: SIM
 ; 1: NÃO
 #DEFINE 	S4	PORTD,4 
 
 ;GRAU DE MOAGEM BIT MENOS SIGNIFICATIVO
 ; 0: SIM
 ; 1: NÃO
 #DEFINE 	S3	PORTD,5 
 
 ;GRAU DE MOAGEM
 ; 0: SIM
 ; 1: NÃO
 #DEFINE 	S2	PORTD,6 
 
 ;GRAU DE MOAGEM BIT MENOS SIGNIFICATIVO
 ; 0: SIM
 ; 1: NÃO
 #DEFINE 	S1	PORTD,7 
 
 ;SENSORES DE TEMPERATURA, BORRA, NÍVEL DE ÁGUA
 ; 0: OK
 ; 1: NOK
 #DEFINE 	SENSORES	PORTB,4 
 
 ;SENSOR DE GRÃOS
 ; 0: OK
 ; 1: NOK
 #DEFINE 	SGRAOS	PORTA,5 
  
 ; --- DEFINIÇÃO DE PINOS DE SAÍDA ---
 
 ;BOMBA 
 ; 0: DESLIGADA
 ; 1: LIGADA
 #DEFINE 	BOMBA	PORTB,6        

 ;MOTOR DE MOAGEM
 ; 0: DESLIGADO
 ; 1: LIGADO
 #DEFINE 	MOTOR	PORTB,7
  
 
 ; --- VETOR DE RESET ---
      ORG 	0X0000								;ENDEREÇO INICIAL
      GOTO 	INICIO
 
 
      ; Reset Vector
RST   code  0x0 
      goto  Start
; Salva contexto
      MOVWF 	W_TEMP 				;Copy W to TEMP register
      SWAPF 	STATUS,W 			;Swap status to be saved into W
      CLRF 	STATUS 				;bank 0, regardless of current bank, Clears IRP,RP1,RP0
      MOVWF 	STATUS_TEMP 			;Save status to bank zero STATUS_TEMP register
      MOVF 	PCLATH, W 			;Only required if using pages 1, 2 and/or 3
      MOVWF 	PCLATH_TEMP 			;Save PCLATH into W
      CLRF 	PCLATH 				;Page zero, regardless of current page
:
:(ISR) ;(Insert user code here)
:


; Recupera contexto
      MOVF  	PCLATH_TEMP, W 			;Restore PCLATH
      MOVWF 	PCLATH 				;Move W into PCLATH
      SWAPF 	STATUS_TEMP,W 			;Swap STATUS_TEMP register into W

      ;(sets bank to original state)

      MOVWF 	STATUS 				;Move W into STATUS register
      SWAPF 	W_TEMP,F 			;Swap W_TEMP
      SWAPF 	W_TEMP,W 			;Swap W_TEMP into W
 
 ; --- VETOR DE INTERRUPÇÃO ---
      ORG 0X0004


      RETFIE  					;RETORNA DA INTERRUPÇÃO
 
 ; --- PROGRAMA PRINCIPAL ---

 INICIO:
      CLRF  	PORTA
      CLRF  	PORTB
      CLRF  	PORTC
      CLRF  	PORTD
   
      BANK1
      MOVLW 	B'00111111'			;RB0 A RB5  COMO ENTRADA, RB6 E RB7  COMO SAÍDA
      MOVWF 	TRISB
   
      MOVLW 	B'11111111'			;RD0 A RD7 COMO ENTRADA - CHAVE SELETORA
      MOVWF 	TRISD
      
 ;     MOVLW B'10000000'
 ;     MOVWF OPTION_REG
   
 ;     MOVLW B'00000100'
 ;     MOVWF INTCON
   
      BANK0
 ;     MOVLW B'00111111'
 ;     MOVWF CMCON
   
 ; --- MAIN ---
   ;carrega registradores para delay
   ;5000000 cycles
      movlw	0x2D
      movwf	d1
      movlw	0xE7
      movwf	d2
      movlw	0x0B
      movwf	d3

 ; --- MAIN ---
      MAIN
      BTFSS	EXPRESS			;TIPO EXPRESSO?
      MOVF	TIPO_CAFE, .5		;SIM, TIPO_CAFE RECEBE 5
      BTFSS	MED			;NÃO, TIPO MÉDIO?
      MOVF	TIPO_CAFE, .10		;SIM, TIPO_CAFE RECEBE 10
      BTFSS	FULL			;NÃO, TIPO GRANDE?
      MOVF	TIPO_CAFE, .15		;SIM, TIPO_CAFE RECEBE 15
           
      CALL 	PRODUZ_CAFE
      GOTO 	MAIN
      
 PRODUZ_CAFE:
      CALL VERIFICA_SENSOR_GRAOS
      CALL VERIFICA_SENSOR_MOAGEM
      CALL VERIFICA_SENSORES
      CALL LIGA_MOEDOR
      CALL LIGA_BOMBA
      RETURN
	      
 VERIFICA_SENSOR_GRAOS:
      BTFSC	SGRAOS				;TEM GRAOS SUFICIENTES?
      CALL	AGUARDA_GRAOS			;NÃO, CONTINUE VERIFICANDO.
      RETURN					;SIM, RETORNA PARA ROTINA DE PREPARO

 AGUARDA_GRAOS:
      CALL	Delay_1s
      DECFSZ	10, 1
      GOTO	AGUARDA_GRAOS
      BTFSC	SGRAOS				;TEM GRAOS SUFICIENTES?
      GOTO	MAIN				;NÃO, VAI PARA MAIN
      RETURN					;SIM
      
 VERIFICA_SENSOR_MOAGEM:
      ;SELGRAOS = 1
      BTFSS	S1				; GRAU 1 SELECIONADO?
      MOVF	GRAU, .1			; SIM, GRAU DE MOAGEM RECEBE 1
      BTFSS	S2				; GRAU 2 SELECIONADO?
      MOVF	GRAU, .2			; SIM, GRAU DE MOAGEM RECEBE 1
      BTFSS	S3				; GRAU 3 SELECIONADO?
      MOVF	GRAU, .3			; SIM, GRAU DE MOAGEM RECEBE 1
      BTFSS	S4				; GRAU 4 SELECIONADO?
      MOVF	GRAU, .4			; SIM, GRAU DE MOAGEM RECEBE 1
      BTFSS	S5				; GRAU 5 SELECIONADO?
      MOVF	GRAU, .5			; SIM, GRAU DE MOAGEM RECEBE 1
      BTFSS	S6				; GRAU 6 SELECIONADO?
      MOVF	GRAU, .6			; SIM, GRAU DE MOAGEM RECEBE 1
      BTFSS	S7				; GRAU 7 SELECIONADO?
      MOVF	GRAU, .7			; SIM, GRAU DE MOAGEM RECEBE 1
      BTFSS	S8				; GRAU 8 SELECIONADO?
      MOVF	GRAU, .8			; SIM, GRAU DE MOAGEM RECEBE 1
      RETURN     
      
  VERIFICA_SENSORES
      BTFSS	SENSORES			; TEM AGUA SUFICIENTE?
      RETURN					; SIM, VAI PARA AGUARDA NIVEL.
      GOTO	ERRO_SENSORES			; NÃO, ESCREVE ERRO NO DISPLAY 
      
 VERIFICA_SENSOR_NIVEL:
      BTFSC	SNIVEL				;TEM AGUA SUFICIENTE?
      GOTO	VERIFICA_SENSOR_NIVEL		;NÃO, VAI PARA AGUARDA NIVEL.
      RETURN					; 
 
 VERIFICA_SENSOR_BORRA:
      BTFSC	SBORRA				;DEPOSITO DE BORRA ESTA VAZIO?
      GOTO	AGUARDA_LIMPEZA			;NÃO, VAI PARA AGUARDA LIMPEZA
      RETURN					;
      
 VERIFICA_SENSOR_TEMPERATURA:
      BTFSC	STEMP				;TEM GRAOS SUFICIENTES?
      GOTO	AGUARDA_TEMPERATURA		;NÃO, CONTINUE VERIFICANDO.
      RETURN					;
    
 LIGA_BOMBA:
      BSF	BOMBA				;LIGA BOMBA
      CALL	Delay_1s
      DECFSZ	TIPO_CAFE
      GOTO	LIGA_BOMBA
      CALL	DESLIGA_BOMBA
      RETURN	

 DESLIGA_BOMBA:   
      BCF	BOMBA				;DESLIGA BOMBA
      RETURN      
 
 LIGA_MOEDOR:
      BSF	MOTOR				;LIGA MOTOR DE MOAGEM
      CALL	Delay_1s
      DECFSZ	GRAU
      GOTO	LIGA_MOEDOR
      BCF	MOTOR
      RETURN
      
; Delay = 1 seconds
; Clock frequency = 20 MHz
; Actual delay = 1 seconds = 5000000 cycles
; Error = 0 %
; 5000000 cycles

 Delay_1s:
      decfsz	d1, f
      goto	$+2
      decfsz	d2, f
      goto	$+2
      decfsz	d3, f
      goto	Delay_1s
      return
 
 END